<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RowChat - Team Communication</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%235865f2'/><text x='50' y='70' text-anchor='middle' font-size='60'>‚õµ</text></svg>">
  
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- CSS Files -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/themes.css">
  <link rel="stylesheet" href="css/animations.css">
  <link rel="stylesheet" href="css/mobile-responsive.css">
  <link rel="stylesheet" href="css/simple-icons.css">
  <link rel="stylesheet" href="css/online-users-dropdown.css">
  <link rel="stylesheet" href="css/message-formatting.css">
  <link rel="stylesheet" href="css/admin-features.css">
  <link rel="stylesheet" href="css/gif-picker-styles.css">
  <link rel="stylesheet" href="css/calls-styles.css">
</head>
<body>

  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading-screen">
    <div class="loading-content">
      <div class="loading-boat">‚õµ</div>
      <h2>RowChat</h2>
      <div class="loading-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <p>Loading your workspace...</p>
    </div>
  </div>

  <!-- Auth Screen -->
  <div class="auth-container" id="authScreen">
    <div class="auth-box">
      <div class="auth-logo">‚õµ</div>
      <h1>Welcome to RowChat</h1>
      <p class="subtitle">Team communication made simple</p>
      
      <div id="authError" class="error-message" style="display: none;"></div>
      
      <!-- Login Form -->
      <div id="loginForm">
        <input type="text" id="loginUsername" placeholder="Username" autocomplete="username">
        <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
        <button class="btn-primary" onclick="login()">Log In</button>
        <div class="divider">or</div>
        <button class="btn-secondary" onclick="showRegister()">Create Account</button>
      </div>
      
      <!-- Register Form -->
      <div id="registerForm" style="display: none;">
        <input type="text" id="registerUsername" placeholder="Username (min 3 characters)" autocomplete="username">
        <input type="email" id="registerEmail" placeholder="Email (optional)" autocomplete="email">
        <input type="password" id="registerPassword" placeholder="Password (min 6 characters)" autocomplete="new-password">
        <input type="password" id="registerConfirm" placeholder="Confirm Password" autocomplete="new-password">
        <button class="btn-primary" onclick="register()">Create Account</button>
        <div class="divider">or</div>
        <button class="btn-secondary" onclick="showLogin()">Back to Login</button>
      </div>
    </div>
  </div>

  <!-- Main App Container -->
  <div class="app-container" id="appContainer" style="display: none;">
    
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="workspace-name">
          <span class="workspace-icon">‚õµ</span>
          <span>RowChat</span>
        </div>
      </div>
      
      <!-- Navigation Tabs -->
      <div class="nav-tabs">
        <button class="nav-tab active" data-tab="rooms" onclick="switchTab('rooms')">
          <span class="icon icon-message-square"></span>
          <span>Rooms</span>
        </button>
        <button class="nav-tab" data-tab="dms" onclick="switchTab('dms')">
          <span class="icon icon-inbox"></span>
          <span>Direct Messages</span>
        </button>
        <button class="nav-tab" data-tab="friends" onclick="switchTab('friends')">
          <span class="icon icon-users"></span>
          <span>Friends</span>
          <span class="notification-badge" id="friendRequestBadge" style="display: none;">0</span>
        </button>
      </div>
      
      <!-- Rooms List -->
      <div class="content-section active" id="roomsSection">
        <div class="section-header">
          <span>Rooms</span>
          <button class="icon-btn" onclick="openCreateRoomModal()" title="Create Room">
            <span class="icon icon-plus"></span>
          </button>
        </div>
        <div id="roomsList" class="rooms-list"></div>
        
        <!-- Admin: View All DMs -->
        <div class="admin-dms-section" id="adminDmsSection" style="display: none;">
          <div class="admin-dms-toggle" onclick="toggleAdminDMs()">
            <span>üî¥ Admin: View All DMs</span>
            <span>‚ñº</span>
          </div>
          <div class="admin-dms-list" id="adminDmsList"></div>
        </div>
      </div>
      
      <!-- DMs List -->
      <div class="content-section" id="dmsSection">
        <div class="section-header">
          <span>Direct Messages</span>
          <button class="icon-btn" onclick="openNewDMModal()" title="New DM">
            <span class="icon icon-plus"></span>
          </button>
        </div>
        <div id="dmsList" class="dms-list"></div>
      </div>
      
      <!-- Friends List -->
      <div class="content-section" id="friendsSection">
        <div class="section-header">
          <span>Friends</span>
          <button class="icon-btn" onclick="openAddFriendModal()" title="Add Friend">
            <span class="icon icon-user-plus"></span>
          </button>
        </div>
        <div class="friends-tabs">
          <button class="friend-tab active" onclick="showFriendTab('online')">Online</button>
          <button class="friend-tab" onclick="showFriendTab('all')">All</button>
          <button class="friend-tab" onclick="showFriendTab('pending')">Pending</button>
        </div>
        <div id="friendsList" class="friends-list"></div>
      </div>
      
      <!-- User Section -->
      <div class="user-section">
        <div class="user-profile" onclick="toggleUserMenu()">
          <div class="user-avatar" id="sidebarAvatar"></div>
          <div class="user-info">
            <div class="user-name" id="sidebarUsername"></div>
            <div class="user-status">
              <span class="online-dot"></span>
              <span>Online</span>
            </div>
          </div>
          <button class="icon-btn">
            <span class="icon icon-settings"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
      
      <!-- Chat Header -->
      <div class="chat-header">
        <div class="chat-header-left">
          <h2 id="chatTitle">Select a room or DM</h2>
          <span id="chatDescription" class="chat-description"></span>
        </div>
        <div class="chat-header-right">
          <div class="chat-actions" id="chatActions"></div>
          <div class="online-users" id="onlineUsers" onclick="toggleOnlineUsersDropdown()">
            <span class="online-dot"></span>
            <span id="onlineCount">0 online</span>
            <div class="online-users-dropdown" id="onlineUsersDropdown">
              <div class="online-users-header">Online Users</div>
              <div id="onlineUsersList"></div>
            </div>
          </div>
          <button class="icon-btn" onclick="openWhiteboardModal()" title="Start Whiteboard">
            <span class="icon icon-palette"></span>
          </button>
          <button class="icon-btn" onclick="openYoutubeModal()" title="Watch YouTube Together">
            <span class="icon icon-youtube"></span>
          </button>
          <button class="icon-btn" onclick="toggleRoomInfo()" title="Room Info">
            <span class="icon icon-info"></span>
          </button>
        </div>
      </div>

      <!-- Messages Container -->
      <div class="messages-container" id="messagesContainer">
        <div class="welcome-message">
          <div class="welcome-icon">‚õµ</div>
          <h3>Welcome to RowChat!</h3>
          <p>Select a room or start a conversation to begin chatting.</p>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div class="typing-indicator" id="typingIndicator"></div>

      <!-- Reply Bar -->
      <div class="reply-bar" id="replyBar" style="display: none;">
        <div class="reply-content">
          <span class="reply-label">Replying to <strong id="replyToUser"></strong></span>
          <span class="reply-text" id="replyToText"></span>
        </div>
        <button class="icon-btn" onclick="cancelReply()">
          <span class="icon icon-x"></span>
        </button>
      </div>

      <!-- Edit Bar -->
      <div class="edit-bar" id="editBar" style="display: none;">
        <div class="edit-content">
          <span class="edit-label"><span class="icon icon-edit-3"></span> Editing message</span>
        </div>
        <button class="icon-btn" onclick="cancelEdit()">
          <span class="icon icon-x"></span>
        </button>
      </div>

      <!-- File Preview Bar -->
      <div class="file-preview-bar" id="filePreviewBar" style="display: none;">
        <div class="file-preview" id="filePreview"></div>
        <button class="icon-btn" onclick="cancelFile()">
          <span class="icon icon-x"></span>
        </button>
      </div>

      <!-- Message Input -->
      <div class="message-input-container">
        <div class="message-input-wrapper">
          <input type="file" id="fileInput" style="display: none;" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt">
          <button class="icon-btn" onclick="document.getElementById('fileInput').click()" title="Upload File">
            <span class="icon icon-paperclip"></span>
          </button>
          <textarea 
            id="messageInput" 
            placeholder="Type a message... (Shift+Enter for new line)" 
            maxlength="2000"
            autocomplete="off"
            rows="1"
          ></textarea>
          <span class="char-count" id="charCount"></span>
          <button class="btn-send" id="sendBtn" onclick="sendMessage()">
            <span class="icon icon-send"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Room Info Panel -->
    <div class="room-info-panel" id="roomInfoPanel">
      <div class="room-info-header">
        <h3>Room Info</h3>
        <button class="icon-btn" onclick="toggleRoomInfo()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="room-info-content" id="roomInfoContent"></div>
    </div>
  </div>

  <!-- User Settings Dropdown -->
  <div class="dropdown-menu" id="userMenu" style="display: none;">
    <div class="dropdown-item" onclick="openProfileModal()">
      <span class="icon icon-user"></span> Edit Profile
    </div>
    <div class="dropdown-item" onclick="openThemeModal()">
      <span class="icon icon-palette"></span> Themes & Appearance
    </div>
    <div class="dropdown-item" onclick="openSettingsModal()">
      <span class="icon icon-settings"></span> Settings
    </div>
    <div class="dropdown-divider"></div>
    <div class="dropdown-item danger" onclick="logout()">
      <span class="icon icon-log-out"></span> Log Out
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Edit Profile</h2>
        <button class="icon-btn" onclick="closeProfileModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="avatar-upload">
          <div class="avatar-preview" id="profileAvatarPreview" onclick="document.getElementById('avatarInput').click()"></div>
          <input type="file" id="avatarInput" accept="image/*" style="display: none;">
          <p class="hint">Click to change avatar</p>
        </div>
        <div class="form-group">
          <label>Display Name</label>
          <input type="text" id="profileDisplayName" placeholder="Your display name">
        </div>
        <div class="form-group">
          <label>Bio</label>
          <textarea id="profileBio" placeholder="Tell us about yourself" maxlength="200"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeProfileModal()">Cancel</button>
        <button class="btn-primary" onclick="saveProfile()">Save</button>
      </div>
    </div>
  </div>

  <!-- Theme Modal -->
  <div class="modal-overlay" id="themeModal">
    <div class="modal modal-large">
      <div class="modal-header">
        <h2><span class="icon icon-palette"></span> Themes & Appearance</h2>
        <button class="icon-btn" onclick="closeThemeModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="theme-section">
          <h3>Theme Presets</h3>
          <div class="theme-grid" id="themePresets"></div>
        </div>
        <div class="theme-section">
          <h3>Font Family</h3>
          <div class="font-grid" id="fontGrid"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeThemeModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Create Room Modal (Enhanced) -->
  <div class="modal-overlay" id="createRoomModal">
    <div class="modal create-room-modal-large">
      <div class="modal-header">
        <h2>Create New Room</h2>
        <button class="icon-btn" onclick="closeCreateRoomModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Room Name *</label>
          <input type="text" id="roomName" placeholder="Enter room name" maxlength="50">
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="roomDescription" placeholder="What's this room about?" maxlength="200" rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label>Room Type</label>
          <select id="roomType">
            <option value="general">üí¨ General Chat</option>
            <option value="study_group">üìö Study Group</option>
            <option value="project">üîß Project</option>
            <option value="gaming">üéÆ Gaming</option>
            <option value="other">üìÅ Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Privacy Setting</label>
          <select id="roomPrivacy" onchange="updatePrivacyInfo()">
            <option value="public">üåê Public - Anyone can join</option>
            <option value="friends_only">üë• Friends Only - Only your friends can see</option>
            <option value="invite_only">‚úâÔ∏è Invite Only - Requires invitation</option>
            <option value="private">üîí Private - Hidden from all non-members</option>
          </select>
        </div>
        
        <div id="privacyInfo" class="privacy-info">
          <strong>Public rooms</strong> are visible to everyone and anyone can join.
        </div>
        
        <div id="inviteUsersSection" style="display: none;">
          <div class="form-group">
            <label>Invite Users</label>
            <input type="text" id="inviteSearch" placeholder="Search users to invite..." oninput="searchUsersToInvite()">
            <div id="inviteUsersList" class="invite-users-list"></div>
          </div>
          <div id="selectedInvites" class="selected-invites"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeCreateRoomModal()">Cancel</button>
        <button class="btn-primary" onclick="createRoomEnhanced()">Create Room</button>
      </div>
    </div>
  </div>

  <!-- Add Friend Modal -->
  <div class="modal-overlay" id="addFriendModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Add Friend</h2>
        <button class="icon-btn" onclick="closeAddFriendModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="friendUsername" placeholder="Enter username">
        </div>
        <p class="hint">Enter the exact username of the person you want to add.</p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeAddFriendModal()">Cancel</button>
        <button class="btn-primary" onclick="sendFriendRequest()">Send Request</button>
      </div>
    </div>
  </div>

  <!-- New DM Modal -->
  <div class="modal-overlay" id="newDMModal">
    <div class="modal">
      <div class="modal-header">
        <h2>New Direct Message</h2>
        <button class="icon-btn" onclick="closeNewDMModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Select Friend</label>
          <div id="dmFriendsList" class="dm-friends-list"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeNewDMModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Whiteboard Modal -->
  <div id="whiteboardModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.85); z-index: 99999; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
    <div class="modal-content" style="width: 900px; max-width: 95vw; max-height: 90vh; background: var(--bg-primary, #1a1a1a); border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--bg-tertiary, #333); flex-shrink: 0;">
        <h3 style="margin: 0; color: var(--text-primary, #fff); font-size: 18px;">
          <span class="icon icon-palette"></span> Collaborative Whiteboard
        </h3>
        <span class="close-btn" onclick="closeWhiteboardModal()" style="font-size: 28px; color: var(--text-secondary, #999); cursor: pointer; line-height: 1; transition: color 0.2s; user-select: none;">&times;</span>
      </div>
      
      <div class="modal-body" style="padding: 20px; overflow-y: auto; flex: 1;">
        <div id="whiteboardColorPicker" style="background: var(--bg-secondary, #252525); padding: 12px; border-radius: 8px; margin-bottom: 12px;"></div>
        
        <div style="background: #1e1e1e; border-radius: 8px; display: flex; justify-content: center; align-items: center; overflow: hidden; box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);">
          <canvas id="whiteboardCanvas" style="border-radius: 8px; cursor: crosshair; display: block;"></canvas>
        </div>
        
        <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: space-between; align-items: center;">
          <button class="btn-secondary" onclick="clearWhiteboard()">
            <span class="icon icon-trash-2"></span> Clear Canvas
          </button>
          <button class="btn-primary" onclick="sendWhiteboardInvite()">
            <span class="icon icon-send"></span> Send Invite
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
  #whiteboardModal.active { display: flex !important; }
  .close-btn:hover { color: var(--text-primary, #fff) !important; }
  </style>

  <!-- YouTube Modal -->
  <div class="modal-overlay" id="youtubeModal">
    <div class="modal modal-large">
      <div class="modal-header">
        <h2><span class="icon icon-youtube"></span> Watch YouTube Together</h2>
        <button class="icon-btn" onclick="closeYoutubeModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>YouTube Video URL or ID</label>
          <input type="text" id="youtubeUrl" placeholder="https://youtube.com/watch?v=...">
        </div>
        <div id="youtubePlayer"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeYoutubeModal()">Close</button>
        <button class="btn-primary" onclick="startYoutubeSession()">Start Session</button>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <img id="modalImage" src="">
  </div>

  <!-- Supabase Configuration -->
  <script>
    console.log('Initializing Supabase...');
    
    const SUPABASE_URL = 'https://oulktlqdkjzrffheszgp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91bGt0bHFka2p6cmZmaGVzemdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NDczMjIsImV4cCI6MjA4MDQyMzMyMn0.OBd7uqt8jiKHdFdk6oIDjDQoerInW-tzqyVjJKlZ9DM';
    
    if (typeof window.supabase === 'undefined') {
      console.error('ERROR: Supabase library not loaded!');
    } else {
      try {
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
          auth: {
            persistSession: true,
            autoRefreshToken: true
          }
        });
        
        window.supabaseClient = supabase;
        console.log('Supabase initialized successfully');
      } catch (error) {
        console.error('Supabase error:', error);
      }
    }
  </script>

  <!-- JavaScript Files -->
  <script src="js/app.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/chat.js"></script>
  <script src="js/rooms.js"></script>
  <script src="js/dms.js"></script>
  <script src="js/friends.js"></script>
  <script src="js/media.js"></script>
  <script src="js/themes.js"></script>
  <script src="js/whiteboard.js"></script>
  <script src="js/youtube.js"></script>
  <script src="js/snowflakes.js"></script>
  <script src="js/gif-picker.js"></script>
  <script src="js/webrtc.js"></script>
  <script src="js/profile-viewer.js"></script>
  <script src="js/roles-status.js"></script>
  <script src="js/admin-features.js"></script>
</body>
</html>
