<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RowChat - Team Communication</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%235865f2'/><text x='50' y='70' text-anchor='middle' font-size='60'>‚õµ</text></svg>">
  
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- CSS Files -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/themes.css">
  <link rel="stylesheet" href="css/animations.css">
  <link rel="stylesheet" href="css/mobile-responsive.css">
  <link rel="stylesheet" href="css/simple-icons.css">
  <link rel="stylesheet" href="css/online-users-dropdown.css">
  <link rel="stylesheet" href="css/message-formatting.css">
  <link rel="stylesheet" href="css/admin-features.css">
  <link rel="stylesheet" href="css/reputation-badges.css">
  <link rel="stylesheet" href="css/gamification.css">
  <link rel="stylesheet" href="css/settings-modal.css">
  <link rel="stylesheet" href="css/moderation.css">
  <link rel="stylesheet" href="css/gif-picker-styles.css">
  <link rel="stylesheet" href="css/calls-styles.css">
</head>
<body>

  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading-screen">
    <div class="loading-content">
      <div class="loading-boat">‚õµ</div>
      <h2>RowChat</h2>
      <div class="loading-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <p>Loading your workspace...</p>
    </div>
  </div>

  <!-- Auth Screen -->
  <div class="auth-container" id="authScreen">
    <div class="auth-box">
      <div class="auth-logo">‚õµ</div>
      <h1>Welcome to RowChat</h1>
      <p class="subtitle">Team communication made simple</p>
      
      <div id="authError" class="error-message" style="display: none;"></div>
      
      <!-- Login Form -->
      <div id="loginForm">
        <input type="text" id="loginUsername" placeholder="Username" autocomplete="username">
        <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
        <button class="btn-primary" onclick="login()">Log In</button>
        <div class="divider">or</div>
        <button class="btn-secondary" onclick="showRegister()">Create Account</button>
      </div>
      
      <!-- Register Form -->
      <div id="registerForm" style="display: none;">
        <input type="text" id="registerUsername" placeholder="Username (min 3 characters)" autocomplete="username">
        <input type="email" id="registerEmail" placeholder="Email (optional)" autocomplete="email">
        <input type="password" id="registerPassword" placeholder="Password (min 6 characters)" autocomplete="new-password">
        <input type="password" id="registerConfirm" placeholder="Confirm Password" autocomplete="new-password">
        <button class="btn-primary" onclick="register()">Create Account</button>
        <div class="divider">or</div>
        <button class="btn-secondary" onclick="showLogin()">Back to Login</button>
      </div>
    </div>
  </div>

  <!-- Main App Container -->
  <div class="app-container" id="appContainer" style="display: none;">
    
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="workspace-name">
          <span class="workspace-icon">‚õµ</span>
          <span>RowChat</span>
        </div>
      </div>
      
      <!-- Navigation Tabs -->
      <div class="nav-tabs">
        <button class="nav-tab active" data-tab="rooms" onclick="switchTab('rooms')">
          <span class="icon icon-message-square"></span>
          <span>Rooms</span>
        </button>
        <button class="nav-tab" data-tab="dms" onclick="switchTab('dms')">
          <span class="icon icon-inbox"></span>
          <span>Direct Messages</span>
        </button>
        <button class="nav-tab" data-tab="friends" onclick="switchTab('friends')">
          <span class="icon icon-users"></span>
          <span>Friends</span>
          <span class="notification-badge" id="friendRequestBadge" style="display: none;">0</span>
        </button>
      </div>
      
      <!-- Rooms List -->
      <div class="content-section active" id="roomsSection">
        <div class="section-header">
          <span>Rooms</span>
          <button class="icon-btn" onclick="openCreateRoomModal()" title="Create Room">
            <span class="icon icon-plus"></span>
          </button>
        </div>
        <div id="roomsList" class="rooms-list"></div>
        
        <!-- Admin: View All DMs -->
        <div class="admin-dms-section" id="adminDmsSection" style="display: none;">
          <div class="admin-dms-toggle" onclick="toggleAdminDMs()">
            <span>Admin Viewing</span>
            <span>‚ñº</span>
          </div>
          <div class="admin-dms-list" id="adminDmsList"></div>
        </div>
      </div>
      
      <!-- DMs List -->
      <div class="content-section" id="dmsSection">
        <div class="section-header">
          <span>Direct Messages</span>
          <button class="icon-btn" onclick="openNewDMModal()" title="New DM">
            <span class="icon icon-plus"></span>
          </button>
        </div>
        <div id="dmsList" class="dms-list"></div>
      </div>
      
      <!-- Friends List -->
      <div class="content-section" id="friendsSection">
        <div class="section-header">
          <span>Friends</span>
          <button class="icon-btn" onclick="openAddFriendModal()" title="Add Friend">
            <span class="icon icon-user-plus"></span>
          </button>
        </div>
        <div class="friends-tabs">
          <button class="friend-tab active" onclick="showFriendTab('online')">Online</button>
          <button class="friend-tab" onclick="showFriendTab('all')">All</button>
          <button class="friend-tab" onclick="showFriendTab('pending')">Pending</button>
        </div>
        <div id="friendsList" class="friends-list"></div>
      </div>
      
      <!-- User Section -->
      <div class="user-section">
        <div class="user-profile">
          <div class="user-avatar" id="sidebarAvatar" onclick="openProfileView(currentUser.id)" style="cursor: pointer;"></div>
          <div class="user-info" onclick="openProfileView(currentUser.id)" style="cursor: pointer;">
            <div class="user-name" id="sidebarUsername"></div>
            <div class="user-status">
              <span class="online-dot"></span>
              <span>Online</span>
            </div>
          </div>
          <button class="icon-btn" onclick="toggleUserMenu()">
            <span class="icon icon-settings"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
      
      <!-- Chat Header -->
      <div class="chat-header">
        <div class="chat-header-left">
          <h2 id="chatTitle">Select a room or DM</h2>
          <span id="chatDescription" class="chat-description"></span>
        </div>
        <div class="chat-header-right">
          <div class="chat-actions" id="chatActions"></div>
          <div class="online-users" id="onlineUsers" onclick="toggleOnlineUsersDropdown()">
            <span class="online-dot"></span>
            <span id="onlineCount">0 online</span>
            <div class="online-users-dropdown" id="onlineUsersDropdown">
              <div class="online-users-header">Online Users</div>
              <div id="onlineUsersList"></div>
            </div>
          </div>
          <button class="icon-btn" onclick="openWhiteboardModal()" title="Start Whiteboard">
            <span class="icon icon-palette"></span>
          </button>
          <button class="icon-btn" onclick="openYoutubeModal()" title="Watch YouTube Together">
            <span class="icon icon-youtube"></span>
          </button>
          <button class="icon-btn" onclick="toggleRoomInfo()" title="Room Info">
            <span class="icon icon-info"></span>
          </button>
        </div>
      </div>

      <!-- Messages Container -->
      <div class="messages-container" id="messagesContainer">
        <div class="welcome-message">
          <div class="welcome-icon">‚õµ</div>
          <h3>Welcome to RowChat!</h3>
          <p>Select a room or start a conversation to begin chatting.</p>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div class="typing-indicator" id="typingIndicator"></div>

      <!-- Reply Bar -->
      <div class="reply-bar" id="replyBar" style="display: none;">
        <div class="reply-content">
          <span class="reply-label">Replying to <strong id="replyToUser"></strong></span>
          <span class="reply-text" id="replyToText"></span>
        </div>
        <button class="icon-btn" onclick="cancelReply()">
          <span class="icon icon-x"></span>
        </button>
      </div>

      <!-- Edit Bar -->
      <div class="edit-bar" id="editBar" style="display: none;">
        <div class="edit-content">
          <span class="edit-label"><span class="icon icon-edit-3"></span> Editing message</span>
        </div>
        <button class="icon-btn" onclick="cancelEdit()">
          <span class="icon icon-x"></span>
        </button>
      </div>

      <!-- File Preview Bar -->
      <div class="file-preview-bar" id="filePreviewBar" style="display: none;">
        <div class="file-preview" id="filePreview"></div>
        <button class="icon-btn" onclick="cancelFile()">
          <span class="icon icon-x"></span>
        </button>
      </div>

      <!-- Message Input -->
      <div class="message-input-container">
        <div class="message-input-wrapper">
          <input type="file" id="fileInput" style="display: none;" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt">
          <button class="icon-btn" onclick="document.getElementById('fileInput').click()" title="Upload File">
            <span class="icon icon-paperclip"></span>
          </button>
          <textarea 
            id="messageInput" 
            placeholder="Type a message... (Shift+Enter for new line)" 
            maxlength="2000"
            autocomplete="off"
            rows="1"
          ></textarea>
          <span class="char-count" id="charCount"></span>
          <button class="btn-send" id="sendBtn" onclick="sendMessage()">
            <span class="icon icon-send"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Room Info Panel -->
    <div class="room-info-panel" id="roomInfoPanel">
      <div class="room-info-header">
        <h3>Room Info</h3>
        <button class="icon-btn" onclick="toggleRoomInfo()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="room-info-content" id="roomInfoContent"></div>
    </div>
  </div>

  <!-- User Settings Dropdown -->
  <div class="dropdown-menu" id="userMenu" style="display: none;">
    <div class="dropdown-item" onclick="openProfileView(currentUser.id); toggleUserMenu();">
      <span class="icon icon-user"></span> View Profile
    </div>
    <div class="dropdown-item" onclick="openProfileModal()">
      <span class="icon icon-edit"></span> Edit Profile
    </div>
    <div class="dropdown-item" onclick="openThemeModal()">
      <span class="icon icon-palette"></span> Themes & Appearance
    </div>
    <div class="dropdown-item" onclick="openAdminPanel()" id="adminPanelLink" style="display: none;">
      <span class="icon icon-shield"></span> Admin Panel
    </div>
    <div class="dropdown-item" onclick="openSettingsModal()">
      <span class="icon icon-settings"></span> Settings
    </div>
    <div class="dropdown-divider"></div>
    <div class="dropdown-item danger" onclick="logout()">
      <span class="icon icon-log-out"></span> Log Out
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Edit Profile</h2>
        <button class="icon-btn" onclick="closeProfileModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="avatar-upload">
          <div class="avatar-preview" id="profileAvatarPreview" onclick="document.getElementById('avatarInput').click()"></div>
          <input type="file" id="avatarInput" accept="image/*" style="display: none;">
          <p class="hint">Click to change avatar</p>
        </div>
        <div class="form-group">
          <label>Display Name</label>
          <input type="text" id="profileDisplayName" placeholder="Your display name">
        </div>
        <div class="form-group">
          <label>Bio</label>
          <textarea id="profileBio" placeholder="Tell us about yourself" maxlength="200"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeProfileModal()">Cancel</button>
        <button class="btn-primary" onclick="saveProfile()">Save</button>
      </div>
    </div>
  </div>

  <!-- Theme Modal -->
  <div class="modal-overlay" id="themeModal">
    <div class="modal modal-large">
      <div class="modal-header">
        <h2><span class="icon icon-palette"></span> Themes & Appearance</h2>
        <button class="icon-btn" onclick="closeThemeModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="theme-section">
          <h3>Theme Presets</h3>
          <div class="theme-grid" id="themePresets"></div>
        </div>
        <div class="theme-section">
          <h3>Font Family</h3>
          <div class="font-grid" id="fontGrid"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeThemeModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal modal-large">
      <div class="modal-header">
        <h2>Settings</h2>
        <button class="icon-btn" onclick="closeSettingsModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        
        <!-- Settings Tabs -->
        <div class="settings-tabs">
          <button class="settings-tab active" data-tab="badges" onclick="switchSettingsTab('badges')">
            Badges
          </button>
          <button class="settings-tab" data-tab="leaderboard" onclick="switchSettingsTab('leaderboard')">
            Leaderboard
          </button>
          <button class="settings-tab" data-tab="filters" onclick="switchSettingsTab('filters')">
            Personal Filters
          </button>
          <button class="settings-tab" data-tab="notifications" onclick="switchSettingsTab('notifications')">
            Notifications
          </button>
          <button class="settings-tab" data-tab="privacy" onclick="switchSettingsTab('privacy')">
            Privacy
          </button>
          <button class="settings-tab" data-tab="account" onclick="switchSettingsTab('account')">
            Account
          </button>
        </div>
        
        <!-- Tab Content -->
        <div class="settings-content">
          
          <!-- Badges Tab -->
          <div class="settings-tab-content active" id="settingsBadges">
            <!-- Equipped Badges Section -->
            <div class="badge-section">
              <h3>Equipped Badges (Max 3)</h3>
              <p class="hint">These badges will be displayed on your profile and messages</p>
              <div class="equipped-badges-container" id="equippedBadgesContainer">
                <div class="equipped-badge-slot empty" data-slot="0">
                  <span class="slot-number">1</span>
                  <span class="slot-text">Empty Slot</span>
                </div>
                <div class="equipped-badge-slot empty" data-slot="1">
                  <span class="slot-number">2</span>
                  <span class="slot-text">Empty Slot</span>
                </div>
                <div class="equipped-badge-slot empty" data-slot="2">
                  <span class="slot-number">3</span>
                  <span class="slot-text">Empty Slot</span>
                </div>
              </div>
            </div>
            
            <!-- Available Badges Section -->
            <div class="badge-section">
              <h3>Available Badges</h3>
              <p class="hint">Click a badge to equip it in an empty slot</p>
              
              <!-- Filter Tabs -->
              <div class="badge-filter-tabs">
                <button class="badge-filter-tab active" data-filter="all" onclick="filterBadges('all')">All</button>
                <button class="badge-filter-tab" data-filter="equipped" onclick="filterBadges('equipped')">Equipped</button>
                <button class="badge-filter-tab" data-filter="unequipped" onclick="filterBadges('unequipped')">Unequipped</button>
              </div>
              
              <div class="available-badges-grid" id="availableBadgesGrid">
                <!-- Badges will be populated here -->
              </div>
            </div>
            
            <!-- Locked Badges Section -->
            <div class="badge-section">
              <h3>Locked Badges</h3>
              <p class="hint">Complete challenges to unlock these badges</p>
              <div class="locked-badges-grid" id="lockedBadgesGrid">
                <!-- Locked badges will be populated here -->
              </div>
            </div>
          </div>
          
          <!-- Leaderboard Tab -->
          <div class="settings-tab-content" id="settingsLeaderboard">
            <div class="leaderboard-filters">
              <button class="leaderboard-filter active" data-category="reputation" onclick="switchLeaderboardCategory('reputation')">Reputation</button>
              <button class="leaderboard-filter" data-category="level" onclick="switchLeaderboardCategory('level')">Level</button>
              <button class="leaderboard-filter" data-category="messages" onclick="switchLeaderboardCategory('messages')">Messages</button>
              <button class="leaderboard-filter" data-category="streak" onclick="switchLeaderboardCategory('streak')">Streak</button>
            </div>
            
            <div class="leaderboard-list" id="leaderboardList">
              <!-- Leaderboard entries will be populated here -->
            </div>
          </div>
          
          <!-- Personal Filters Tab -->
          <div class="settings-tab-content" id="settingsFilters">
            <div class="setting-group">
              <h3>Personal Word Filters</h3>
              <p class="setting-description" style="margin-bottom: 16px;">
                Add words you want to hide. Filtered words will appear blurred and you can click to reveal them.
              </p>
              
              <div class="add-filter-section">
                <input type="text" id="newFilterWord" placeholder="Enter word to filter..." maxlength="50">
                <button class="btn-primary" onclick="addPersonalFilter()">Add Filter</button>
              </div>
              
              <div id="personalFiltersList" class="personal-filters-list">
                <!-- Filters will be loaded here -->
              </div>
            </div>
          </div>
          
          <!-- Notifications Tab -->
          <div class="settings-tab-content" id="settingsNotifications">
            <div class="setting-group">
              <h3>Notification Preferences</h3>
              <div class="setting-item">
                <label class="setting-label">
                  <input type="checkbox" id="notifyMentions" checked>
                  <span>Mentions</span>
                </label>
                <p class="setting-description">Get notified when someone @mentions you</p>
              </div>
              <div class="setting-item">
                <label class="setting-label">
                  <input type="checkbox" id="notifyDMs" checked>
                  <span>Direct Messages</span>
                </label>
                <p class="setting-description">Get notified for new direct messages</p>
              </div>
              <div class="setting-item">
                <label class="setting-label">
                  <input type="checkbox" id="notifyFriendRequests" checked>
                  <span>Friend Requests</span>
                </label>
                <p class="setting-description">Get notified when someone sends a friend request</p>
              </div>
              <div class="setting-item">
                <label class="setting-label">
                  <input type="checkbox" id="notifyStreaks" checked>
                  <span>Streak Reminders</span>
                </label>
                <p class="setting-description">Remind me to maintain my login streak</p>
              </div>
            </div>
          </div>
          
          <!-- Privacy Tab -->
          <div class="settings-tab-content" id="settingsPrivacy">
            <div class="setting-group">
              <h3>Privacy Settings</h3>
              <div class="setting-item">
                <label class="setting-label">
                  <input type="checkbox" id="showOnlineStatus" checked>
                  <span>Show Online Status</span>
                </label>
                <p class="setting-description">Let others see when you're online</p>
              </div>
              <div class="setting-item">
                <label class="setting-label">
                  <input type="checkbox" id="showActivity" checked>
                  <span>Show Activity</span>
                </label>
                <p class="setting-description">Show your current activity to friends</p>
              </div>
            </div>
            
            <div class="setting-group">
              <h3>Badge Display</h3>
              <div class="setting-item">
                <label class="setting-label">
                  <input type="checkbox" id="hidePriorityBadges">
                  <span>Hide Priority Badges</span>
                </label>
                <p class="setting-description">Hide role badges (ADMIN, MOD) and reputation tier badges (MYTHIC, LEGEND, etc). Only show your 3 equipped badges.</p>
              </div>
            </div>
          </div>
          
          <!-- Account Tab -->
          <div class="settings-tab-content" id="settingsAccount">
            <div class="setting-group">
              <h3>Account Information</h3>
              <p class="hint">Username: <strong id="settingsUsername"></strong></p>
              <p class="hint">Member since: <strong id="settingsMemberSince"></strong></p>
              <p class="hint">Level: <strong id="settingsLevel"></strong></p>
              <p class="hint">XP: <strong id="settingsXP"></strong></p>
              <p class="hint">Reputation: <strong id="settingsReputation"></strong></p>
            </div>
            <div class="setting-group">
              <h3>Danger Zone</h3>
              <button class="btn-danger" onclick="confirmDeleteAccount()">Delete Account</button>
            </div>
          </div>
          
        </div>
        
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeSettingsModal()">Close</button>
        <button class="btn-primary" onclick="saveSettings()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Create Room Modal (Enhanced) -->
  <div class="modal-overlay" id="createRoomModal">
    <div class="modal create-room-modal-large">
      <div class="modal-header">
        <h2>Create New Room</h2>
        <button class="icon-btn" onclick="closeCreateRoomModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Room Name *</label>
          <input type="text" id="roomName" placeholder="Enter room name" maxlength="50">
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="roomDescription" placeholder="What's this room about?" maxlength="200" rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label>Room Type</label>
          <select id="roomType">
            <option value="general">üí¨ General Chat</option>
            <option value="study_group">üìö Study Group</option>
            <option value="project">üîß Project</option>
            <option value="gaming">üéÆ Gaming</option>
            <option value="other">üìÅ Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Privacy Setting</label>
          <select id="roomPrivacy" onchange="updatePrivacyInfo()">
            <option value="public">üåê Public - Anyone can join</option>
            <option value="friends_only">üë• Friends Only - Only your friends can see</option>
            <option value="invite_only">‚úâÔ∏è Invite Only - Requires invitation</option>
            <option value="private">üîí Private - Hidden from all non-members</option>
          </select>
        </div>
        
        <div id="privacyInfo" class="privacy-info">
          <strong>Public rooms</strong> are visible to everyone and anyone can join.
        </div>
        
        <div id="inviteUsersSection" style="display: none;">
          <div class="form-group">
            <label>Invite Users</label>
            <input type="text" id="inviteSearch" placeholder="Search users to invite..." oninput="searchUsersToInvite()">
            <div id="inviteUsersList" class="invite-users-list"></div>
          </div>
          <div id="selectedInvites" class="selected-invites"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeCreateRoomModal()">Cancel</button>
        <button class="btn-primary" onclick="createRoomEnhanced()">Create Room</button>
      </div>
    </div>
  </div>

  <!-- Add Friend Modal -->
  <div class="modal-overlay" id="addFriendModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Add Friend</h2>
        <button class="icon-btn" onclick="closeAddFriendModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="friendUsername" placeholder="Enter username">
        </div>
        <p class="hint">Enter the exact username of the person you want to add.</p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeAddFriendModal()">Cancel</button>
        <button class="btn-primary" onclick="sendFriendRequest()">Send Request</button>
      </div>
    </div>
  </div>

  <!-- New DM Modal -->
  <div class="modal-overlay" id="newDMModal">
    <div class="modal">
      <div class="modal-header">
        <h2>New Direct Message</h2>
        <button class="icon-btn" onclick="closeNewDMModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Select Friend</label>
          <div id="dmFriendsList" class="dm-friends-list"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeNewDMModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Whiteboard Modal -->
  <div id="whiteboardModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.85); z-index: 99999; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
    <div class="modal-content" style="width: 900px; max-width: 95vw; max-height: 90vh; background: var(--bg-primary, #1a1a1a); border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--bg-tertiary, #333); flex-shrink: 0;">
        <h3 style="margin: 0; color: var(--text-primary, #fff); font-size: 18px;">
          <span class="icon icon-palette"></span> Collaborative Whiteboard
        </h3>
        <span class="close-btn" onclick="closeWhiteboardModal()" style="font-size: 28px; color: var(--text-secondary, #999); cursor: pointer; line-height: 1; transition: color 0.2s; user-select: none;">&times;</span>
      </div>
      
      <div class="modal-body" style="padding: 20px; overflow-y: auto; flex: 1;">
        <div id="whiteboardColorPicker" style="background: var(--bg-secondary, #252525); padding: 12px; border-radius: 8px; margin-bottom: 12px;"></div>
        
        <div style="background: #1e1e1e; border-radius: 8px; display: flex; justify-content: center; align-items: center; overflow: hidden; box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);">
          <canvas id="whiteboardCanvas" style="border-radius: 8px; cursor: crosshair; display: block;"></canvas>
        </div>
        
        <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: space-between; align-items: center;">
          <button class="btn-secondary" onclick="clearWhiteboard()">
            <span class="icon icon-trash-2"></span> Clear Canvas
          </button>
          <button class="btn-primary" onclick="sendWhiteboardInvite()">
            <span class="icon icon-send"></span> Send Invite
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
  #whiteboardModal.active { display: flex !important; }
  .close-btn:hover { color: var(--text-primary, #fff) !important; }
  </style>

  <!-- YouTube Modal -->
  <div class="modal-overlay" id="youtubeModal">
    <div class="modal modal-large">
      <div class="modal-header">
        <h2><span class="icon icon-youtube"></span> Watch YouTube Together</h2>
        <button class="icon-btn" onclick="closeYoutubeModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>YouTube Video URL or ID</label>
          <input type="text" id="youtubeUrl" placeholder="https://youtube.com/watch?v=...">
        </div>
        <div id="youtubePlayer"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeYoutubeModal()">Close</button>
        <button class="btn-primary" onclick="startYoutubeSession()">Start Session</button>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <img id="modalImage" src="">
  </div>

  <!-- MODERATION MODALS START -->
  
  <!-- Admin Panel Modal -->
  <div class="modal-overlay" id="adminPanelModal">
    <div class="modal modal-large">
      <div class="modal-header">
        <h2>Admin Panel</h2>
        <button class="icon-btn" onclick="closeAdminPanel()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="admin-tabs">
          <button class="admin-tab active" data-admin-tab="dashboard" onclick="switchAdminTab('dashboard')">Dashboard</button>
          <button class="admin-tab" data-admin-tab="bans" onclick="switchAdminTab('bans')">Bans</button>
          <button class="admin-tab" data-admin-tab="timeouts" onclick="switchAdminTab('timeouts')">Timeouts</button>
          <button class="admin-tab" data-admin-tab="flagged" onclick="switchAdminTab('flagged')">Flagged</button>
          <button class="admin-tab" data-admin-tab="reports" onclick="switchAdminTab('reports')">Reports</button>
          <button class="admin-tab" data-admin-tab="audit" onclick="switchAdminTab('audit')">Audit Logs</button>
          <button class="admin-tab" data-admin-tab="filters" onclick="switchAdminTab('filters')">Filters</button>
          <button class="admin-tab" data-admin-tab="words" onclick="switchAdminTab('words')">Bad Words</button>
        </div>
        <div class="admin-content">
          <div class="admin-tab-content active" id="adminDashboard">
            <h3>Overview</h3>
            <div class="dashboard-stats">
              <div class="stat-card">
                <div class="stat-card-value" id="statsActiveBans">0</div>
                <div class="stat-card-label">Active Bans</div>
              </div>
              <div class="stat-card">
                <div class="stat-card-value" id="statsActiveTimeouts">0</div>
                <div class="stat-card-label">Active Timeouts</div>
              </div>
              <div class="stat-card">
                <div class="stat-card-value" id="statsActiveWarnings">0</div>
                <div class="stat-card-label">Active Warnings</div>
              </div>
              <div class="stat-card">
                <div class="stat-card-value" id="statsFlaggedMessages">0</div>
                <div class="stat-card-label">Flagged Messages</div>
              </div>
              <div class="stat-card">
                <div class="stat-card-value" id="statsPendingReports">0</div>
                <div class="stat-card-label">Pending Reports</div>
              </div>
            </div>
            <h3>Recent Actions</h3>
            <div id="recentActionsList"></div>
          </div>
          <div class="admin-tab-content" id="adminBans">
            <h3>Active Bans</h3>
            <div id="bansList"></div>
          </div>
          <div class="admin-tab-content" id="adminTimeouts">
            <h3>Active Timeouts</h3>
            <div id="timeoutsList"></div>
          </div>
          <div class="admin-tab-content" id="adminFlagged">
            <h3>Flagged Messages</h3>
            <div id="flaggedMessagesList"></div>
          </div>
          <div class="admin-tab-content" id="adminReports">
            <h3>Pending Reports</h3>
            <div id="reportsList"></div>
          </div>
          <div class="admin-tab-content" id="adminAudit">
            <h3>Audit Logs</h3>
            <div id="auditLogsList"></div>
          </div>
          <div class="admin-tab-content" id="adminFilters">
            <h3>Auto-Moderation Filters</h3>
            <div id="filterSettingsList"></div>
          </div>
          <div class="admin-tab-content" id="adminWords">
            <h3>Custom Bad Words</h3>
            <button class="add-bad-word-btn" onclick="addBadWord()">Add Word</button>
            <div id="badWordsList"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeAdminPanel()">Close</button>
      </div>
    </div>
  </div>

  <!-- Ban User Modal -->
  <div class="modal-overlay" id="banModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Ban User</h2>
        <button class="icon-btn" onclick="closeBanModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="banUsername" readonly>
          <input type="hidden" id="banUserId">
        </div>
        <div class="form-group">
          <label>Reason</label>
          <textarea id="banReason" placeholder="Enter ban reason..." rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label>Ban Type</label>
          <select id="banType" onchange="toggleBanDuration()">
            <option value="permanent">Permanent</option>
            <option value="temporary">Temporary</option>
          </select>
        </div>
        <div class="form-group" id="banDurationGroup" style="display: none;">
          <label>Duration</label>
          <select id="banDuration">
            <option value="3600000">1 Hour</option>
            <option value="21600000">6 Hours</option>
            <option value="86400000">24 Hours</option>
            <option value="259200000">3 Days</option>
            <option value="604800000">7 Days</option>
            <option value="2592000000">30 Days</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeBanModal()">Cancel</button>
        <button class="btn-danger" onclick="executeBan()">Ban User</button>
      </div>
    </div>
  </div>

  <!-- Timeout User Modal -->
  <div class="modal-overlay" id="timeoutModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Timeout User</h2>
        <button class="icon-btn" onclick="closeTimeoutModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="timeoutUsername" readonly>
          <input type="hidden" id="timeoutUserId">
        </div>
        <div class="form-group">
          <label>Reason</label>
          <textarea id="timeoutReason" placeholder="Enter timeout reason..." rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label>Duration</label>
          <div class="timeout-quick-buttons">
            <button class="timeout-quick-btn" onclick="setTimeoutDuration(60000)">1 Min</button>
            <button class="timeout-quick-btn" onclick="setTimeoutDuration(300000)">5 Min</button>
            <button class="timeout-quick-btn" onclick="setTimeoutDuration(600000)">10 Min</button>
            <button class="timeout-quick-btn" onclick="setTimeoutDuration(3600000)">1 Hour</button>
            <button class="timeout-quick-btn" onclick="setTimeoutDuration(86400000)">24 Hours</button>
          </div>
          <input type="number" id="timeoutDuration" placeholder="Custom duration (minutes)" min="1">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeTimeoutModal()">Cancel</button>
        <button class="btn-warning" onclick="executeTimeout()">Timeout User</button>
      </div>
    </div>
  </div>

  <!-- Warn User Modal -->
  <div class="modal-overlay" id="warnModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Warn User</h2>
        <button class="icon-btn" onclick="closeWarnModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="warnUsername" readonly>
          <input type="hidden" id="warnUserId">
        </div>
        <div class="form-group">
          <label>Reason</label>
          <textarea id="warnReason" placeholder="Enter warning reason..." rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label>Severity</label>
          <select id="warnSeverity">
            <option value="1">Level 1 - Yellow (Friendly Warning)</option>
            <option value="2">Level 2 - Orange (10 min timeout)</option>
            <option value="3">Level 3 - Red (1 hour timeout)</option>
            <option value="4">Level 4+ - Escalating Ban</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeWarnModal()">Cancel</button>
        <button class="btn-warning" onclick="executeWarn()">Warn User</button>
      </div>
    </div>
  </div>

  <!-- Confirm Send Sensitive Data Modal -->
  <div class="modal-overlay" id="confirmSensitiveModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Confirm Message</h2>
        <button class="icon-btn" onclick="closeConfirmSensitiveModal()">
          <span class="icon icon-x"></span>
        </button>
      </div>
      <div class="modal-body">
        <p id="confirmSensitiveMessage"></p>
        <p style="font-size: 14px; color: var(--text-secondary); margin-top: 12px;">
          Sharing personal information like emails, phone numbers, or IP addresses can be risky. 
          Make sure you trust who you're sharing this with.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="cancelSensitiveMessage()">Cancel</button>
        <button class="btn-primary" onclick="confirmSensitiveMessage()">Yes, Send It</button>
      </div>
    </div>
  </div>

  <!-- MODERATION MODALS END -->

  <!-- Supabase Configuration -->
  <script>
    console.log('Initializing Supabase...');
    
    const SUPABASE_URL = 'https://oulktlqdkjzrffheszgp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91bGt0bHFka2p6cmZmaGVzemdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NDczMjIsImV4cCI6MjA4MDQyMzMyMn0.OBd7uqt8jiKHdFdk6oIDjDQoerInW-tzqyVjJKlZ9DM';
    
    if (typeof window.supabase === 'undefined') {
      console.error('ERROR: Supabase library not loaded!');
    } else {
      try {
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
          auth: {
            persistSession: true,
            autoRefreshToken: true
          }
        });
        
        window.supabaseClient = supabase;
        console.log('Supabase initialized successfully');
      } catch (error) {
        console.error('Supabase error:', error);
      }
    }
  </script>

  <!-- JavaScript Files -->
  <script src="js/app.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/chat.js"></script>
  <script src="js/rooms.js"></script>
  <script src="js/dms.js"></script>
  <script src="js/friends.js"></script>
  <script src="js/media.js"></script>
  <script src="js/themes.js"></script>
  <script src="js/whiteboard.js"></script>
  <script src="js/youtube.js"></script>
  <script src="js/snowflakes.js"></script>
  <script src="js/gif-picker.js"></script>
  <script src="js/webrtc.js"></script>
  <script src="js/profile-viewer.js"></script>
  <script src="js/roles-status.js"></script>
  <script src="js/admin-features.js"></script>
  <script src="js/reputation-system.js"></script>
  <script src="js/gamification.js"></script>
  <script src="js/badge-settings.js"></script>
  <script src="js/leaderboard.js"></script>
  <script src="js/moderation.js"></script>
  <script src="js/personal-filters.js"></script>
</body>
</html>
